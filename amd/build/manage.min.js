define(["core/ajax","core/str"],function(a,b){function c(a,b){var c=document.getElementById("asyntai-alert");c&&(c.style.display="block",c.className="alert "+(b?"alert-success":"alert-danger"),c.textContent=a)}function d(){return"moodle_"+Math.random().toString(36).substr(2,9)}function e(a){var b=document.getElementById("asyntai-fallback-link");b&&a&&(b.href="https://asyntai.com/moodle-auth?platform=moodle&state="+encodeURIComponent(a))}function f(a,b,c){var d=0;!function e(){if(!(d++>60)){var f=document.createElement("script"),g="asyntai_cb_"+Date.now(),h=a||"https://asyntai.com";f.src=h+"/connect-status.js?state="+encodeURIComponent(b)+"&cb="+g,window[g]=function(a){try{delete window[g]}catch(a){}a&&a.site_id?c(a):setTimeout(e,500)},f.onerror=function(){setTimeout(e,1e3)},document.head.appendChild(f)}}()}function g(a,b,d){var e=document.getElementById("asyntai-status");if(e){var f=a.status+': <span style="color:#008a20;">'+a.connected+"</span>";b&&(f+=" "+a.as+" "+b+' <a class="btn btn-secondary" style="margin-left:8px;" href="'+(d||"#")+'">'+a.reset+"</a>"),e.innerHTML=f}var g=document.getElementById("asyntai-connected-box");g&&(g.style.display="block");var h=document.getElementById("asyntai-popup-wrap");h&&(h.style.display="none")}function h(){return b.get_strings([{key:"popupblocked",component:"local_asyntai"},{key:"saving",component:"local_asyntai"},{key:"enabled",component:"local_asyntai"},{key:"savefailed",component:"local_asyntai"},{key:"couldnotsave",component:"local_asyntai"},{key:"status",component:"local_asyntai"},{key:"connected",component:"local_asyntai"},{key:"as",component:"local_asyntai"},{key:"reset",component:"local_asyntai"}]).then(function(a){return{popupblocked:a[0],saving:a[1],enabled:a[2],savefailed:a[3],couldnotsave:a[4],status:a[5],connected:a[6],as:a[7],reset:a[8]}})}function i(b){b=b||{};var i=d();e(i),document.addEventListener("click",function(j){var k=j.target;if(k&&"asyntai-connect-btn"===k.id&&(j.preventDefault(),h().then(function(j){var k=b.connectUrl||"";if(k){var l=k+(k.indexOf("?")>-1?"&":"?")+"state="+encodeURIComponent(i),m=800,n=720,o=window.top.outerHeight/2+window.top.screenY-n/2,p=window.top.outerWidth/2+window.top.screenX-m/2,q=window.open(l,"asyntai_connect","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+m+",height="+n+",top="+o+",left="+p);return q?void f(b.expectedOrigin,i,function(d){c(j.saving,!0),a.call([{methodname:"local_asyntai_save_connection",args:{siteid:d.site_id||"",scripturl:d.script_url||"",accountemail:d.account_email||""}}])[0].then(function(a){g(j,d.account_email,b.resetUrl),c(j.enabled,!0)}).catch(function(a){window.console&&console.error&&console.error("[Asyntai] save error",a);var b=j.couldnotsave.replace("{$a}",a&&a.message||a);c(b,!1)})}):void c(j.popupblocked,!1)}})),k&&"asyntai-fallback-link"===k.id){j.preventDefault(),i=d(),e(i);var l="https://asyntai.com/moodle-auth?platform=moodle&state="+encodeURIComponent(i);window.open(l,"_blank","noopener,noreferrer"),setTimeout(function(){f(b.expectedOrigin,i,function(d){h().then(function(e){c(e.saving,!0),a.call([{methodname:"local_asyntai_save_connection",args:{siteid:d.site_id||"",scripturl:d.script_url||"",accountemail:d.account_email||""}}])[0].then(function(a){g(e,d.account_email,b.resetUrl),c(e.enabled,!0)}).catch(function(a){window.console&&console.error&&console.error("[Asyntai] save error",a);var b=e.couldnotsave.replace("{$a}",a&&a.message||a);c(b,!1)})})})},1e3)}})}return{init:i}});
